<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>マグナ学習管理ダッシュボード (モックアップ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
  <style>
    /* Chart.jsのツールチップがTailwind CSSより前面に出るように調整 */
    canvas {
      /* グラフがコンテナの高さを超えないように */
      max-height: 300px;
    }

    .chart-container {
      position: relative;
      height: 400px; /* 高さを400pxに */
      width: 100%;
    }

    /* 選択中のタブのスタイル */
    .tab-active {
      border-bottom: 2px solid #3B82F6;
      /* blue-500 */
      color: #3B82F6;
      font-weight: 600;
    }

    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6B7280;
      /* gray-500 */
    }
  </style>
</head>

<body class="bg-slate-100 font-sans">
  <div class="container mx-auto p-4 max-w-7xl">

    <!-- ヘッダーとタブナビゲーション -->
    <header class="mb-4">
      <h1 class="text-3xl font-bold text-slate-800 mb-4">マグナ学習管理ダッシュボード</h1>
      <nav class="bg-white rounded-lg shadow-sm">
        <div class="flex border-b border-slate-200">
          <button id="tab-school" onclick="showView('school')"
            class="tab-active py-3 px-6 text-sm focus:outline-none">学校全体</button>
          <button id="tab-class" onclick="showView('class')"
            class="tab-inactive py-3 px-6 text-sm focus:outline-none">クラス詳細</button>
          <button id="tab-student" onclick="showView('student')"
            class="tab-inactive py-3 px-6 text-sm focus:outline-none">生徒詳細</button>
        </div>
      </nav>
    </header>

    <main>
      <!-- #################### -->
      <!-- 学校全体ビュー -->
      <!-- #################### -->
      <div id="school-view">
        <!-- 学年フィルタ -->
        <div class="mb-4 bg-white p-4 rounded-lg shadow-sm flex items-center space-x-2">
          <label for="grade-filter" class="text-sm font-semibold text-slate-600">学年フィルタ:</label>
          <select id="grade-filter" class="border rounded px-3 py-1 text-sm">
            <option value="all">すべての学年</option>
            <option value="1">1年生</option>
            <option value="2">2年生</option>
            <option value="3">3年生</option>
          </select>
        </div>

        <!-- KPIカード -->
        <div class="mb-4">
          <h2 class="text-xl font-bold text-slate-700 mb-3">生徒1人あたり 月間平均サマリー</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 全体プレー時間 -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <div class="text-sm font-medium text-slate-500">全体プレー時間</div>
              <div id="kpi-play-time" class="text-5xl font-bold text-blue-600 my-2">16.8h</div>
              <div class="text-xs text-slate-500 mt-2">※従来の自主学習時間(1日15分)比で <strong
                  class="text-blue-600">約30%</strong> の学習時間が純増しています。</div>
            </div>
            <!-- 習得単語数 -->
            <div class="bg-white p-6 rounded-lg shadow-sm relative">
              <div class="text-sm font-medium text-slate-500">習得単語数 (中学3年間目標: 1800語)</div>
              <div class="chart-container" style="height: 150px; width: 150px; margin: 10px auto 0;">
                <canvas id="kpi-words-chart" style="max-height: 150px;"></canvas>
              </div>
              <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 mt-4 flex flex-col items-center justify-center">
                <div id="kpi-words-percent" class="text-4xl font-bold text-green-600">19%</div>
                <div class="text-sm text-slate-500">達成</div>
              </div>
              <div class="text-xs text-slate-500 mt-2 text-center">※1ヶ月で中学3年間の目標の <strong
                  class="text-green-600">15%</strong> に到達しています。</div>
            </div>
            <!-- AI英会話プレー時間 -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <div class="text-sm font-medium text-slate-500">AI英会話 プレー時間（分）</div>
              <div id="kpi-ai-time" class="text-5xl font-bold text-red-600 my-2">88 分</div>
              <div class="text-xs text-slate-500 mt-2">※授業内だけでは実現困難な、 <strong
                  class="text-red-600">アウトプット時間</strong> です。</div>
            </div>
          </div>
        </div>

        <!-- グラフエリア (2カラム固定) -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- 学習効果の証明 -->
          <div class="bg-white p-6 rounded-lg shadow-sm chart-container">
            <h3 class="text-lg font-semibold text-slate-700 mb-2">学習効果の証明 (プレイ時間 vs 習得単語数)</h3>
            <canvas id="comparison-chart"></canvas>
            <!-- ▼ 静的テキスト（Looker Studioのテキストボックス想定）▼ -->
            <p class="chart-conclusion text-center text-sm text-slate-600 font-medium mt-2">「自律学習時間（プレイ時間）」が長い生徒ほど、「習得単語数」が伸びる傾向を示します。</p>
          </div>
          <!-- 学習時間の内訳 -->
          <div class="bg-white p-6 rounded-lg shadow-sm chart-container">
            <h3 class="text-lg font-semibold text-slate-700 mb-2">学習時間の内訳 (ゲームプレイ = 学習活動)</h3>
            <canvas id="breakdown-chart"></canvas>
            <!-- ▼ 静的テキスト（Looker Studioのテキストボックス想定）▼ -->
            <p class="chart-conclusion text-center text-sm text-slate-600 font-medium mt-2">「遊び」に見える時間も、その多くが4技能に紐づく「学習活動」であることを示します。</p>
          </div>
        </div>

        <!-- No.1クラス -->
        <div class="mb-4">
          <h2 class="text-xl font-bold text-slate-700 mb-3">指標別 No.1 クラス (活用事例の発見)</h2>
          <div id="top-class-grid" class="grid grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- JSによってカードが挿入されます -->
          </div>
        </div>
      </div>

      <!-- #################### -->
      <!-- クラス詳細ビュー -->
      <!-- #################### -->
      <div id="class-view" class="hidden">
        <!-- クラスフィルタ -->
        <div class="mb-4 bg-white p-4 rounded-lg shadow-sm flex items-center space-x-2">
          <label for="class-filter" class="text-sm font-semibold text-slate-600">クラス選択:</label>
          <select id="class-filter" class="border rounded px-3 py-1 text-sm">
            <option value="1-1">1年1組</option>
            <option value="1-2">1年2組</option>
          </select>
        </div>

        <!-- グラフエリア (2カラム固定) -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- 4技能バランス -->
          <div class="bg-white p-6 rounded-lg shadow-sm chart-container">
            <h3 class="text-lg font-semibold text-slate-700 mb-2">4技能バランス (クラス平均 vs 学年平均)</h3>
            <canvas id="skill-bar-chart"></canvas>
          </div>
          <!-- 成長の軌跡 -->
          <div class="bg-white p-6 rounded-lg shadow-sm chart-container">
            <h3 class="text-lg font-semibold text-slate-700 mb-2">クラスの成長の軌跡 (習得単語数)</h3>
            <canvas id="growth-line-chart"></canvas>
          </div>
        </div>

        <!-- 生徒一覧 -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4">
          <h3 class="text-lg font-semibold text-slate-700 p-6">生徒一覧 (クリックして並び替え)</h3>
          <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
              <!-- ▼▼▼ ここからUI変更 ▼▼▼ -->
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer sortable"
                  data-sort="name">生徒名</th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer sortable"
                  data-sort="x">今月の学習時間</th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer sortable"
                  data-sort="y">今月の習得語彙数</th>
                <!-- 「先月比」の列を削除 -->
              </tr>
              <!-- ▲▲▲ ここまでUI変更 ▲▲▲ -->
            </thead>
            <tbody id="student-list" class="bg-white divide-y divide-slate-200">
              <!-- JSによって生徒が挿入されます -->
            </tbody>
          </table>
        </div>

        <!-- クラス指導メモ (擬似タブ廃止) -->
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">クラス指導メモ</h3>

          <!-- 入力欄 (常時表示) -->
          <div>
            <h4 class="text-sm font-semibold text-slate-600 mb-2">📝 メモを入力</h4>
            <textarea class="w-full h-24 border rounded p-2 text-sm"></textarea>
            <button class="mt-2 bg-blue-500 text-white px-4 py-1 rounded text-sm">メモを保存 (ダミー)</button>
          </div>

          <!-- 履歴 (常時表示) -->
          <div class="mt-6">
            <h4 class="text-sm font-semibold text-slate-600 mb-2">📖 メモ履歴</h4>
            <div class="border rounded-lg overflow-hidden">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase w-32">日付</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">メモ内容</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 text-sm">
                  <tr>
                    <td class="px-4 py-2 align-top">2025/10/01</td>
                    <td class="px-4 py-2">学習時間が全体的に低下傾向。夏休みの反動か。声かけを強化する。</td>
                  </tr>
                  <tr>
                    <td class="px-4 py-2 align-top">2025/09/01</td>
                    <td class="px-4 py-2">新学期スタート。特にA3, C1のスタートダッシュが良い。</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

      <!-- #################### -->
      <!-- 生徒詳細ビュー -->
      <!-- #################### -->
      <div id="student-view" class="hidden">
        <!-- フィルタ -->
        <div class="mb-4 bg-white p-4 rounded-lg shadow-sm flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <label for="student-class-filter" class="text-sm font-semibold text-slate-600">クラス選択:</label>
            <select id="student-class-filter" class="border rounded px-3 py-1 text-sm">
              <option value="1-1">1年1組</option>
              <option value="1-2">1年2組</option>
            </select>
          </div>
          <div class="flex items-center space-x-2">
            <label for="student-filter" class="text-sm font-semibold text-slate-600">生徒選択:</label>
            <select id="student-filter" class="border rounded px-3 py-1 text-sm">
              <!-- JSによって生徒が挿入されます -->
            </select>
          </div>
        </div>

        <!-- 生徒サマリー -->
        <div class="mb-4">
          <h2 id="student-name-header" class="text-2xl font-bold text-slate-800 mb-3">生徒 A1</h2>

          <!-- クラス内順位 (新規追加) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="bg-white p-4 rounded-lg shadow-sm text-center">
              <div class="text-sm font-medium text-slate-500">今月の学習時間 (クラス内順位)</div>
              <div id="student-rank-time" class="text-3xl font-bold text-slate-700 my-2">--</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm text-center">
              <div class="text-sm font-medium text-slate-500">おぼえた単語数 (クラス内順位)</div>
              <div id="student-rank-words" class="text-3xl font-bold text-slate-700 my-2">--</div>
            </div>
          </div>

          <!-- KPIカード (既存) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 今月の学習時間 -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <div class="text-sm font-medium text-slate-500">今月の学習時間</div>
              <div id="student-summary-time" class="text-4xl font-bold text-blue-600 my-2">
                <!-- JSで "25.5h" のように挿入 (先月比を削除) -->
              </div>
            </div>
            <!-- 今月の習得単語数 -->
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <div class="text-sm font-medium text-slate-500">今月の習得単語数</div>
              <div id="student-summary-words" class="text-4xl font-bold text-green-600 my-2">
                 <!-- JSで "510語" のように挿入 (先月比を削除) -->
              </div>
            </div>
          </div>
        </div>


        <!-- グラフエリア (2カラム固定) -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- 6技能バランス (棒グラフに変更) -->
          <div class="bg-white p-6 rounded-lg shadow-sm chart-container">
            <h3 class="text-lg font-semibold text-slate-700 mb-2">6技能バランス (個人 vs クラス平均)</h3>
            <canvas id="student-skill-bar-chart"></canvas>
            <!-- ▼▼▼ ここからUI変更 ▼▼▼ -->
            <p class="chart-conclusion text-center text-sm text-slate-600 font-medium mt-2">青色（本人）グレー（クラス平均）を比べ、得意・不得意なスキルを把握できます。</p>
            <!-- ▲▲▲ ここまでUI変更 ▲▲▲ -->
          </div>

          <!-- クラス内ポジション (グラフを削除) -->

          <!-- 学習時間の内訳 -->
          <div class="bg-white p-6 rounded-lg shadow-sm chart-container">
            <h3 class="text-lg font-semibold text-slate-700 mb-2">学習時間の内訳 (ゲームプレイ = 学習活動)</h3>
            <canvas id="student-breakdown-chart"></canvas>
            <!-- ▼▼▼ ここからUI変更 ▼▼▼ -->
            <p class="chart-conclusion text-center text-sm text-slate-600 font-medium mt-2">ストーリー（聞く）中心か、バトル（話す）中心か、学習の「偏り」＝「好み」が分かります。</p>
            <!-- ▲▲▲ ここまでUI変更 ▲▲▲ -->
          </div>
        </div>

        <!-- 個別フォローアップ・プラン (擬似タブ廃止 & ページ下部に移動) -->
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">個別フォローアップ・プラン</h3>

          <!-- 入力欄 (常時表示) -->
          <div>
            <h4 class="text-sm font-semibold text-slate-600 mb-2">📝 メモを入力</h4>
            <textarea class="w-full h-24 border rounded p-2 text-sm"></textarea>
            <button class="mt-2 bg-blue-500 text-white px-4 py-1 rounded text-sm">メモを保存 (ダミー)</button>
          </div>

          <!-- 履歴 (常時表示) -->
          <div class="mt-6">
            <h4 class="text-sm font-semibold text-slate-600 mb-2">📖 メモ履歴</h4>
            <div class="border rounded-lg overflow-hidden">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase w-32">日付</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">メモ内容</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 text-sm">
                  <tr>
                    <td class="px-4 py-2 align-top">2025/10/01</td>
                    <td class="px-4 py-2">先月比で語彙数が大幅減。学習スタイルを確認する。</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    // ####################
    // ダミーデータ
    // ####################
    // ▼▼▼ ここからUI変更 ▼▼▼
    // prev_x, prev_y を削除
    const allStudentData = [
      // 1-1組 (n=5)
      { id: "A1", name: "生徒 A1", classId: "1-1", x: 19.9, y: 255, skills: { listen: 90, speak: 60, read: 70, write: 50, phrase: 40, ai: 80 }, breakdown: { story: 60, battle: 30, mini: 10 } },
      { id: "A2", name: "生徒 A2", classId: "1-1", x: 15.2, y: 350, skills: { listen: 70, speak: 80, read: 80, write: 75, phrase: 70, ai: 90 }, breakdown: { story: 30, battle: 40, mini: 30 } },
      { id: "A3", name: "生徒 A3", classId: "1-1", x: 8.1, y: 150, skills: { listen: 60, speak: 50, read: 60, write: 40, phrase: 30, ai: 50 }, breakdown: { story: 50, battle: 20, mini: 30 } },
      { id: "A4", name: "生徒 A4", classId: "1-1", x: 25.0, y: 410, skills: { listen: 85, speak: 90, read: 80, write: 80, phrase: 80, ai: 100 }, breakdown: { story: 40, battle: 40, mini: 20 } },
      { id: "A5", name: "生徒 A5", classId: "1-1", x: 3.5, y: 50, skills: { listen: 40, speak: 30, read: 40, write: 20, phrase: 10, ai: 10 }, breakdown: { story: 70, battle: 10, mini: 20 } },
      // 1-2組 (n=5)
      { id: "B1", name: "生徒 B1", classId: "1-2", x: 22.0, y: 380, skills: { listen: 80, speak: 85, read: 75, write: 70, phrase: 75, ai: 95 }, breakdown: { story: 40, battle: 40, mini: 20 } },
      { id: "B2", name: "生徒 B2", classId: "1-2", x: 18.5, y: 310, skills: { listen: 75, speak: 70, read: 80, write: 65, phrase: 60, ai: 70 }, breakdown: { story: 50, battle: 30, mini: 20 } },
      { id: "B3", name: "生徒 B3", classId: "1-2", x: 10.0, y: 180, skills: { listen: 65, speak: 60, read: 70, write: 55, phrase: 50, ai: 60 }, breakdown: { story: 60, battle: 20, mini: 20 } },
      { id: "B4", name: "生徒 B4", classId: "1-2", x: 5.0, y: 80, skills: { listen: 50, speak: 40, read: 55, write: 30, phrase: 20, ai: 30 }, breakdown: { story: 70, battle: 20, mini: 10 } },
      { id: "B5", name: "生徒 B5", classId: "1-2", x: 12.0, y: 220, skills: { listen: 70, speak: 65, read: 70, write: 60, phrase: 55, ai: 65 }, breakdown: { story: 55, battle: 25, mini: 25 } },
    ];
    // ▲▲▲ ここまでUI変更 ▲▲▲

    // 全学年平均 (ダミー)
    const gradeAvgSkills = { listen: 70, speak: 65, read: 70, write: 60, phrase: 50, ai: 60 };
    const gradeAvgGrowth = [
      { month: "4月", words: 50 },
      { month: "5月", words: 120 },
      { month: "6月", words: 200 },
      { month: "7月", words: 280 },
      { month: "8月", words: 350 },
      { month: "9月", words: 430 },
    ];

    // グローバル変数 (Chartインスタンス保持用)
    const charts = {};
    let currentSort = { column: 'x', order: 'desc' };
    let currentClassId = "1-1";
    let currentStudentId = "A1";

    // ####################
    // 汎用ヘルパー関数
    // ####################

    // Chart.jsインスタンスを破棄するヘルパー
    function destroyChart(chartId) {
      if (charts[chartId]) {
        charts[chartId].destroy();
        delete charts[chartId];
      }
    }

    // ネストされたプロパティを安全に取得するヘルパー
    function getNestedProperty(obj, path) {
      // 'skills.ai' -> ['skills', 'ai']
      return path.split('.').reduce((acc, part) => {
        // (acc && acc[part] !== undefined) ? acc[part] : 0
        // 0を返す前に、acc[part]がnullの場合も考慮する
        if (acc && acc[part] !== undefined && acc[part] !== null) {
          return acc[part];
        }
        return 0; // 見つからないかundefined/nullなら0を返す
      }, obj);
    }

    // 平均を計算するヘルパー (ネスト対応)
    function getAverage(data, key) {
      if (data.length === 0) return 0;
      const total = data.reduce((acc, item) => {
        const value = getNestedProperty(item, key); // 修正！
        // valueが数値であることを確認
        return acc + (typeof value === 'number' ? value : 0);
      }, 0);
      return total / data.length;
    }


    // スキルの平均を計算するヘルパー
    function getAverageSkills(data) {
      const avg = { listen: 0, speak: 0, read: 0, write: 0, phrase: 0, ai: 0 };
      if (data.length === 0) return avg;
      const keys = Object.keys(avg); // ['listen', 'speak', ...]
      for (const key of keys) {
        // 'skills.listen' のようなネストしたキーを渡す
        avg[key] = getAverage(data, `skills.${key}`);
      }
      return avg;
    }

    // ####################
    // 学校全体ビュー (School View)
    // ####################

    // KPI: 習得単語数 (ドーナツ)
    function createKpiWordsChart(data) {
      destroyChart('kpi-words-chart');
      const avgWords = getAverage(data, 'y');
      const targetWords = 1800;
      const percent = (targetWords > 0) ? Math.round((avgWords / targetWords) * 100) : 0;

      document.getElementById('kpi-words-percent').innerText = `${percent}%`;

      const ctx = document.getElementById('kpi-words-chart').getContext('2d');
      charts['kpi-words-chart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [avgWords, Math.max(0, targetWords - avgWords)], // マイナスにならないように
            backgroundColor: ['#4ade80', '#e5e7eb'], // green-400, gray-200
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '75%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
    }

    // グラフ: 学習効果の証明 (棒グラフ)
    function createComparisonBarChart(data) {
      destroyChart('comparison-chart');
      if (data.length === 0) {
        return; // データがなければ何もしない
      }

      const sortedByTime = [...data].sort((a, b) => a.x - b.x);
      const shortest = sortedByTime[0];
      const longest = sortedByTime[sortedByTime.length - 1];

      const ctx = document.getElementById('comparison-chart').getContext('2d');
      charts['comparison-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['習得単語数'],
          datasets: [
            {
              label: `プレイ時間 最短 (${shortest.name}: ${shortest.x}h)`,
              data: [shortest.y],
              backgroundColor: '#94a3b8', // slate-400
            },
            {
              label: `プレイ時間 最長 (${longest.name}: ${longest.x}h)`,
              data: [longest.y],
              backgroundColor: '#3b82f6', // blue-500
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: (context) => `${context.dataset.label}: ${context.raw}単語`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '習得単語数'
              }
            },
            x: {
              title: {
                display: false
              }
            }
          }
        }
      });
      // JavaScriptによる結論テキストの更新は行わない
    }

    // グラフ: 学習時間の内訳 (ドーナツ)
    function createBreakdownChart(data) {
      destroyChart('breakdown-chart');
      if (data.length === 0) {
         return; // データがなければ何もしない
      }

      const avgBreakdown = { story: 0, battle: 0, mini: 0 };
      const keys = Object.keys(avgBreakdown);
      for (const key of keys) {
        avgBreakdown[key] = getAverage(data, `breakdown.${key}`);
      }

      const ctx = document.getElementById('breakdown-chart').getContext('2d');
      charts['breakdown-chart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [`ストーリー (聞く・読む)`, `バトル (話す・書く)`, `単語学習 (ミニゲーム)`],
          datasets: [{
            data: [avgBreakdown.story, avgBreakdown.battle, avgBreakdown.mini],
            backgroundColor: ['#60a5fa', '#f87171', '#facc15'], // blue-400, red-400, yellow-400
            borderColor: '#ffffff',
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: (context) => `${context.label}: ${context.raw.toFixed(1)}%`
              }
            }
          }
        }
      });
      // JavaScriptによる結論テキストの更新は行わない
    }

    // No.1 クラス グリッド
    function renderTop1Grid(data) {
      const grid = document.getElementById('top-class-grid');
      grid.innerHTML = '';
      if (data.length === 0) {
        grid.innerHTML = '<p class="text-slate-500">データがありません。</p>';
        return;
      }

      const metrics = [
        { key: 'skills.listen', name: '英単語マスター (聞く)', unit: '単語' },
        { key: 'skills.speak', name: '英単語マスター (話す)', unit: '単語' },
        { key: 'skills.read', name: '英単語マスター (読む)', unit: '単語' },
        { key: 'skills.write', name: '英単語マスター (書く)', unit: '単語' },
        { key: 'skills.phrase', name: '英会話フレーズ数', unit: 'フレーズ' },
        { key: 'skills.ai', name: 'AI英会話 プレー時間（分）', unit: '分' }
      ];

      metrics.forEach(metric => {
        const classAverages = {};
        data.forEach(student => {
          if (!classAverages[student.classId]) {
            classAverages[student.classId] = { total: 0, count: 0, name: student.classId };
          }
          // ネストされたプロパティを安全に取得
          classAverages[student.classId].total += getNestedProperty(student, metric.key);
          classAverages[student.classId].count++;
        });

        const sortedClasses = Object.values(classAverages)
          .map(c => ({ ...c, avg: c.total / c.count }))
          .sort((a, b) => b.avg - a.avg);

        const topClass = sortedClasses[0];
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200';

        // 文字列を変更しない
        card.innerHTML = `
          <div class="text-sm font-semibold text-slate-700">${metric.name}</div>
          <div class="my-2">
            <span class="text-2xl font-bold text-blue-600">${topClass.name}</span>
          </div>
          <div class="text-xs text-slate-500">平均 ${topClass.avg.toFixed(1)} ${metric.unit}</div>
        `;

        grid.appendChild(card);
      });
    }

    // 学校全体ビュー 更新
    function updateSchoolView() {
      const grade = document.getElementById('grade-filter').value;
      // フィルタロジック (ダミー)
      const filteredData = allStudentData;

      // KPIカード
      const avgPlayTime = getAverage(filteredData, 'x');
      const avgAiTime = getAverage(filteredData, 'skills.ai'); // 'skills.ai' を使用

      document.getElementById('kpi-play-time').innerText = `${avgPlayTime.toFixed(1)}h`;
      // NaNチェックを追加
      document.getElementById('kpi-ai-time').innerText = isNaN(avgAiTime) ? '0 分' : `${avgAiTime.toFixed(0)} 分`;

      createKpiWordsChart(filteredData);
      createComparisonBarChart(filteredData);
      createBreakdownChart(filteredData);
      renderTop1Grid(filteredData);
    }


    // ####################
    // クラス詳細ビュー (Class View)
    // ####################

    // グラフ: 4技能バランス (棒グラフ)
    function createSkillBarChart(data) {
      destroyChart('skill-bar-chart');
      if (data.length === 0) return;

      const classAvg = getAverageSkills(data);
      const labels = ['聞く', '話す', '読む', '書く'];
      const classData = [classAvg.listen, classAvg.speak, classAvg.read, classAvg.write];
      const gradeData = [gradeAvgSkills.listen, gradeAvgSkills.speak, gradeAvgSkills.read, gradeAvgSkills.write];

      const ctx = document.getElementById('skill-bar-chart').getContext('2d');
      charts['skill-bar-chart'] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'クラス平均',
              data: classData,
              backgroundColor: '#3b82f6', // blue-500
            },
            {
              label: '学年平均',
              data: gradeData,
              backgroundColor: '#cbd5e1', // slate-300
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12 }
            }
          },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }

    // グラフ: 成長の軌跡 (折れ線)
    function createGrowthLineChart(data) {
      destroyChart('growth-line-chart');
      // クラスの成長 (ダミー)
      const classGrowth = gradeAvgGrowth.map(item => ({
        month: item.month,
        words: item.words * (Math.random() * 0.4 + 0.8) // 学年平均の80-120%
      }));

      const ctx = document.getElementById('growth-line-chart').getContext('2d');
      charts['growth-line-chart'] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: classGrowth.map(d => d.month),
          datasets: [
            {
              label: 'クラス平均',
              data: classGrowth.map(d => d.words),
              borderColor: '#3b82f6', // blue-500
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.1
            },
            {
              label: '学年平均',
              data: gradeAvgGrowth.map(d => d.words),
              borderColor: '#cbd5e1', // slate-300
              fill: false,
              borderDash: [5, 5],
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12 }
            }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: '累計習得単語数' } }
          }
        }
      });
    }

    // 生徒一覧
    function renderStudentList(data, sortColumn, sortOrder) {
      const list = document.getElementById('student-list');
      list.innerHTML = '';

      // ▼▼▼ ここからUI変更 ▼▼▼
      const sortedData = [...data].sort((a, b) => {
        let aVal, bVal;
        // diff_ のソートロジックを削除
        aVal = getNestedProperty(a, sortColumn); // 'name' や 'x', 'y'
        bVal = getNestedProperty(b, sortColumn);

        if (typeof aVal === 'string') {
          return sortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
      });

      sortedData.forEach(student => {
        const row = document.createElement('tr');

        row.className = "hover:bg-slate-50"; // C. 画面遷移（クリックイベント）を削除

        // diffX/Yのロジックと、該当セルを削除
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${student.name}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            <div class="w-24 h-4 bg-slate-200 rounded">
              <div class="h-4 bg-blue-500 rounded" style="width: ${student.x * 4}%"></div>
            </div>
            <span class="ml-2">${student.x.toFixed(1)}h</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            <div class="w-24 h-4 bg-slate-200 rounded">
              <div class="h-4 bg-green-500 rounded" style="width: ${student.y / 5}%"></div>
            </div>
            <span class="ml-2">${student.y.toFixed(0)}語</span>
          </td>
        `;
        // ▲▲▲ ここまでUI変更 ▲▲▲
        list.appendChild(row);
      });
    }

    // クラス詳細ビュー 更新
    function updateClassView() {
      currentClassId = document.getElementById('class-filter').value;
      const classData = allStudentData.filter(s => s.classId === currentClassId);

      createSkillBarChart(classData);
      createGrowthLineChart(classData);
      renderStudentList(classData, currentSort.column, currentSort.order);
    }


    // ####################
    // 生徒詳細ビュー (Student View)
    // ####################

    // F. 6技能バランス (棒グラフ)
    function createStudentSkillBarChart(student, classAvg) {
        destroyChart('student-skill-bar-chart');

        const labels = ['聞く', '話す', '読む', '書く', 'フレーズ', 'AI会話'];
        const studentData = [
            student.skills.listen, student.skills.speak, student.skills.read,
            student.skills.write, student.skills.phrase, student.skills.ai
        ];
        const classData = [
            classAvg.listen, classAvg.speak, classAvg.read,
            classAvg.write, classAvg.phrase, classAvg.ai
        ];

        const ctx = document.getElementById('student-skill-bar-chart').getContext('2d');
        charts['student-skill-bar-chart'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: `本人 (${student.name})`,
                        data: studentData,
                        backgroundColor: '#3b82f6', // blue-500
                    },
                    {
                        label: 'クラス平均',
                        data: classData,
                        backgroundColor: '#cbd5e1', // slate-300
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12 } }
                },
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }

    // ▼▼▼ ここからUI変更 ▼▼▼
    // D. 散布図 (関数を削除)
    /*
    function createStudentScatterChart(student, classData) {
      // ... (関数全体を削除)
    }
    */
    // ▲▲▲ ここまでUI変更 ▲▲▲


    // グラフ: 学習時間の内訳 (ドーナツ) - 生徒個人
    function createStudentBreakdownChart(student) {
      destroyChart('student-breakdown-chart');
      const breakdown = student.breakdown;

      const ctx = document.getElementById('student-breakdown-chart').getContext('2d');
      charts['student-breakdown-chart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [`ストーリー (聞く・読む)`, `バトル (話す・書く)`, `単語学習 (ミニゲーム)`],
          datasets: [{
            data: [breakdown.story, breakdown.battle, breakdown.mini],
            backgroundColor: ['#60a5fa', '#f87171', '#facc15'], // blue-400, red-400, yellow-400
            borderColor: '#ffffff',
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { boxWidth: 12 }
            },
            tooltip: {
              callbacks: {
                label: (context) => `${context.label}: ${context.raw.toFixed(1)}%`
              }
            }
          }
        }
      });
    }

    // 生徒詳細フィルタ populated
    function populateStudentFilter(classId) {
      const studentFilter = document.getElementById('student-filter');
      studentFilter.innerHTML = '';
      allStudentData
        .filter(s => s.classId === classId)
        .forEach(s => {
          const option = document.createElement('option');
          option.value = s.id;
          option.text = s.name;
          studentFilter.appendChild(option);
        });
      // フィルタの現在の値も更新
      if (allStudentData.some(s => s.classId === classId && s.id === currentStudentId)) {
        studentFilter.value = currentStudentId;
      } else {
        // クラスが変更され、現在の生徒がそのクラスにいない場合、最初の生徒を選択
        if (studentFilter.options.length > 0) {
            studentFilter.selectedIndex = 0;
            currentStudentId = studentFilter.value;
        } else {
            currentStudentId = null; // 生徒がいない
        }
      }
    }

    // 生徒詳細ビュー コンテンツ描画
    function renderStudentViewContent() {
      const student = allStudentData.find(s => s.id === currentStudentId);
      const classData = allStudentData.filter(s => s.classId === currentClassId);
      const classAvg = getAverageSkills(classData);

      if (!student) {
        // 生徒が選択されていない場合のUI
        document.getElementById('student-name-header').innerText = "生徒を選択してください";
        // カードのテキストをクリア
        document.getElementById('student-summary-time').innerHTML = '--';
        document.getElementById('student-summary-words').innerHTML = '--';
        // ▼▼▼ ここからUI変更 ▼▼▼
        // 順位カードもクリア
        document.getElementById('student-rank-time').innerHTML = '--';
        document.getElementById('student-rank-words').innerHTML = '--';
        // グラフをクリア
        destroyChart('student-skill-bar-chart');
        // destroyChart('student-scatter-chart'); // 削除済み
        destroyChart('student-breakdown-chart');
        return;
      }
      // ▲▲▲ ここまでUI変更 ▲▲▲


      // ▼▼▼ ここからUI変更ロジック ▼▼▼
      document.getElementById('student-name-header').innerText = student.name;

      // サマリーカード (先月比を削除)
      document.getElementById('student-summary-time').innerHTML = `${student.x.toFixed(1)}h`;
      document.getElementById('student-summary-words').innerHTML = `${student.y.toFixed(0)}語`;

      // 順位カード (新規追加)
      const classSize = classData.length;
      // 学習時間の順位
      const sortedByTime = [...classData].sort((a, b) => b.x - a.x);
      const timeRank = sortedByTime.findIndex(s => s.id === student.id) + 1;
      document.getElementById('student-rank-time').innerHTML =
        `<span class="text-blue-600">${timeRank}</span><span class="text-lg">位</span> / ${classSize}人中`;

      // 習得単語数の順位
      const sortedByWords = [...classData].sort((a, b) => b.y - a.y);
      const wordsRank = sortedByWords.findIndex(s => s.id === student.id) + 1;
      document.getElementById('student-rank-words').innerHTML =
        `<span class="text-green-600">${wordsRank}</span><span class="text-lg">位</span> / ${classSize}人中`;
      // ▲▲▲ ここまでUI変更ロジック ▲▲▲


      // グラフ
      createStudentSkillBarChart(student, classAvg);
      // createStudentScatterChart(student, classData); // 削除済み
      createStudentBreakdownChart(student);
    }

    // 生徒詳細ビュー 更新
    function updateStudentView() {
        currentClassId = document.getElementById('student-class-filter').value;
        currentStudentId = document.getElementById('student-filter').value;
        renderStudentViewContent();
    }


    // ####################
    // メインロジック (タブ切り替え・初期化)
    // ####################

    function showView(view) {
      // 全ビューを非表示
      document.getElementById('school-view').classList.add('hidden');
      document.getElementById('class-view').classList.add('hidden');
      document.getElementById('student-view').classList.add('hidden');
      // 全タブを非アクティブ
      document.getElementById('tab-school').classList.replace('tab-active', 'tab-inactive');
      document.getElementById('tab-class').classList.replace('tab-active', 'tab-inactive');
      document.getElementById('tab-student').classList.replace('tab-active', 'tab-inactive');

      // 対象ビューを表示
      document.getElementById(`${view}-view`).classList.remove('hidden');
      // 対象タブをアクティブ化
      document.getElementById(`tab-${view}`).classList.replace('tab-inactive', 'tab-active');

      // 各ビューの更新
      if (view === 'school') {
        updateSchoolView();
      } else if (view === 'class') {
        updateClassView();
      } else if (view === 'student') {
        // 生徒詳細タブを開いた時、フィルタが初期化されるように
        populateStudentFilter(currentClassId); // クラスフィルタの現在の値に基づいて生徒フィルタを更新
        updateStudentView(); // フィルタに基づいてコンテンツを描画
      }
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
      // 学校全体
      document.getElementById('grade-filter').addEventListener('change', updateSchoolView);

      // クラス詳細
      document.getElementById('class-filter').addEventListener('change', updateClassView);
      document.querySelectorAll('#class-view .sortable').forEach(header => {
        header.addEventListener('click', () => {
          const column = header.dataset.sort;
          const order = (column === currentSort.column && currentSort.order === 'asc') ? 'desc' : 'asc';
          currentSort = { column, order };
          updateClassView();
        });
      });

      // 生徒詳細
      document.getElementById('student-class-filter').addEventListener('change', (e) => {
        currentClassId = e.target.value;
        populateStudentFilter(currentClassId); // クラス変更時に生徒フィルタを更新
        updateStudentView();
      });
      document.getElementById('student-filter').addEventListener('change', (e) => {
        currentStudentId = e.target.value;
        updateStudentView();a
      });

      // 初期表示
      // 生徒詳細タブのフィルタを初期化
      populateStudentFilter(currentClassId);
      document.getElementById('student-class-filter').value = currentClassId;
      document.getElementById('student-filter').value = currentStudentId;
      // 学校全体ビューを最初に表示
      showView('school');
    });

  </script>
</body>

</html>