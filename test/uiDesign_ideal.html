<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚°ãƒŠå­¦ç¿’ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8f9fa;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .kpi-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            background: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .top-class-card {
            transition: all 0.3s ease;
        }
        .top-class-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            cursor: pointer;
        }
        .student-list-header th {
            cursor: pointer;
            user-select: none;
        }
        .student-list-header th:hover {
            background-color: #f3f4f6;
        }
        .student-list-header .sort-asc::after {
            content: ' â–²';
            font-size: 0.75em;
        }
        .student-list-header .sort-desc::after {
            content: ' â–¼';
            font-size: 0.75em;
        }
        #student-list tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        /* æŒ‡å°ãƒ¡ãƒ¢ã®æ“¬ä¼¼ã‚¿ãƒ– */
        .memo-tab-button {
            transition: all 0.2s ease;
        }
        .memo-tab-button.active {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .memo-tab-button:not(.active) {
            background-color: #e5e7eb;
            color: #4b5563;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ– -->
        <header class="bg-slate-800 text-white p-6">
            <h1 class="text-2xl md:text-3xl font-bold">ãƒã‚°ãƒŠã¨ãµã—ãã®å°‘å¥³ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p class="text-sm text-slate-300 mt-1">ã€Œç†±ä¸­ã€ãŒã€Œå­¦ç¿’æˆæœã€ã«å¤‰ã‚ã‚‹ç¬é–“ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚</p>
        </header>

        <nav class="flex border-b border-slate-200">
            <button id="school-tab" class="tab-button active text-sm md:text-base py-4 px-6 border-b-4 border-transparent">
                å­¦æ ¡å…¨ä½“
            </button>
            <button id="class-tab" class="tab-button text-sm md:text-base py-4 px-6 border-b-4 border-transparent">
                ã‚¯ãƒ©ã‚¹è©³ç´°
            </button>
            <button id="student-tab" class="tab-button text-sm md:text-base py-4 px-6 border-b-4 border-transparent">
                ç”Ÿå¾’è©³ç´°
            </button>
        </nav>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <main classs="p-4 md:p-8">

            <!-- å­¦æ ¡å…¨ä½“ãƒ“ãƒ¥ãƒ¼ -->
            <div id="school-view" class="view-content p-4 md:p-8">
                <!-- å­¦å¹´ãƒ•ã‚£ãƒ«ã‚¿ -->
                <div class="mb-6">
                    <label for="grade-filter" class="text-sm font-medium text-slate-700 mr-2">å­¦å¹´ï¼š</label>
                    <select id="grade-filter" class="rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="all" selected>ã™ã¹ã¦ã®å­¦å¹´</option>
                        <option value="1å¹´ç”Ÿ">1å¹´ç”Ÿ</option>
                        <option value="2å¹´ç”Ÿ">2å¹´ç”Ÿ</option>
                        <option value="3å¹´ç”Ÿ">3å¹´ç”Ÿ</option>
                    </select>
                </div>

                <!-- 1. KPIã‚«ãƒ¼ãƒ‰ -->
                <h2 class="text-xl font-semibold text-slate-800 mb-4">ç”Ÿå¾’1äººã‚ãŸã‚Š æœˆé–“å¹³å‡ã‚µãƒãƒªãƒ¼</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-4">
                    <!-- å˜èª -->
                    <div class="kpi-card bg-white p-5 rounded-lg border border-slate-200">
                        <div class="text-sm font-medium text-slate-500">ç¿’å¾—å˜èªæ•°</div>
                        <div class="w-full flex items-center pt-2">
                            <div class="w-2/3">
                                <canvas id="kpi-words-chart"></canvas>
                            </div>
                            <div class="w-1/3 text-right">
                                <div class="text-2xl font-bold text-green-600" id="kpi-words-text">15%</div>
                                <div class="text-xs text-slate-500">é”æˆ</div>
                            </div>
                        </div>
                    </div>
                    <!-- ç™ºè©± -->
                    <div class="kpi-card bg-white p-5 rounded-lg border border-slate-200">
                        <div class="text-sm font-medium text-slate-500">AIè‹±ä¼šè©± ãƒ—ãƒ¬ãƒ¼æ™‚é–“ï¼ˆåˆ†ï¼‰</div>
                        <div class="text-3xl font-bold text-red-600 mt-1" id="kpi-speaking">158 åˆ†</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div class="space-y-3">
                        <div class="text-base font-semibold text-slate-700 p-3 bg-white rounded-lg border border-slate-200">ä¸­å­¦3å¹´é–“ç›®æ¨™: 1800èª</div>
                        <div class="text-sm md:text-base text-slate-600 p-3 bg-white rounded-lg border border-slate-200">â€»1ãƒ¶æœˆã§ä¸­å­¦3å¹´é–“ã®ç›®æ¨™ã® <strong class="text-green-600">15%</strong> ã«åˆ°é”ã—ã¦ã„ã¾ã™ã€‚</div>
                    </div>
                    <div class="text-sm md:text-base text-slate-600 p-3 bg-white rounded-lg border border-slate-200">â€»æˆæ¥­å†…ã ã‘ã§ã¯å®Ÿç¾å›°é›£ãªã€<strong class="text-red-600">ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆæ™‚é–“</strong>ã§ã™ã€‚</div>
                </div>

                <!-- 2. å­¦ç¿’åŠ¹æœã¨å†…è¨³ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-8">
                    <!-- å­¦ç¿’åŠ¹æœ -->
                    <div class="flex flex-col space-y-3">
                        <div class="chart-container">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">å­¦ç¿’åŠ¹æœ (ãƒ—ãƒ¬ãƒ¼æ™‚é–“ vs ç¿’å¾—å˜èªæ•°)</h3>
                            <canvas id="comparison-bar-chart"></canvas>
                        </div>
                        <div class="text-sm md:text-base font-semibold text-slate-700 p-3 bg-slate-100 rounded-lg text-center">
                            ãƒ—ãƒ¬ãƒ¼æ™‚é–“ãŒ<strong class="text-blue-600">æœ€é•·ã®ç”Ÿå¾’</strong>ã¯ã€<strong class="text-slate-500">æœ€çŸ­ã®ç”Ÿå¾’</strong>ã«æ¯”ã¹ã€<strong class="text-green-600">å˜èªç¿’å¾—æ•°ãŒç´„5å€</strong>ã«å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚
                        </div>
                    </div>
                    <!-- å­¦ç¿’ã®å†…è¨³ -->
                    <div class="flex flex-col space-y-3">
                        <div class="chart-container">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">å­¦ç¿’æ™‚é–“ã®å†…è¨³ (ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ¼ = å­¦ç¿’æ´»å‹•)</h3>
                            <canvas id="breakdown-chart"></canvas>
                        </div>
                        <div class="text-sm md:text-base font-semibold text-slate-700 p-3 bg-slate-100 rounded-lg text-center">
                            ã€ŒéŠã³ã€ã«è¦‹ãˆã‚‹æ™‚é–“ã‚‚ã€ãã®<strong class="text-blue-600">100%</strong>ãŒ4æŠ€èƒ½ã«ç´ã¥ã<strong class="text-green-600">ã€Œå­¦ç¿’æ´»å‹•ã€</strong>ã§ã™ã€‚
                        </div>
                    </div>
                </div>

                <!-- 3. ãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ -->
                <h2 class="text-xl font-semibold text-slate-800 mb-4">æŒ‡æ¨™åˆ¥ No.1 ã‚¯ãƒ©ã‚¹ (æ´»ç”¨äº‹ä¾‹ã®ç™ºè¦‹)</h2>
                <div id="top-class-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6">
                    <!-- JSã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>

            </div>

            <!-- ã‚¯ãƒ©ã‚¹è©³ç´°ãƒ“ãƒ¥ãƒ¼ -->
            <div id="class-view" class="view-content p-4 md:p-8" style="display: none;">
                <!-- ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ -->
                <div class="mb-6">
                    <label for="class-filter" class="text-sm font-medium text-slate-700 mr-2">ã‚¯ãƒ©ã‚¹ï¼š</label>
                    <select id="class-filter" class="rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="1-1">1å¹´1çµ„</option>
                        <option value="1-2">1å¹´2çµ„</option>
                        <option value="2-1">2å¹´1çµ„</option>
                        <option value="3-1">3å¹´1çµ„</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 md:gap-6">
                    <!-- 4æŠ€èƒ½ãƒãƒ©ãƒ³ã‚¹ -->
                    <div class="chart-container">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">4æŠ€èƒ½ãƒãƒ©ãƒ³ã‚¹ (ã‚¯ãƒ©ã‚¹å¹³å‡ vs å­¦å¹´å¹³å‡)</h3>
                        <canvas id="skill-bar-chart"></canvas>
                    </div>

                    <!-- æ™‚ç³»åˆ—æ¨ç§» -->
                    <div class="chart-container">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">4æŠ€èƒ½ ç¿’å¾—æ•°ã®æœˆåˆ¥æ¨ç§»</h3>
                        <canvas id="time-series-chart"></canvas>
                    </div>
                </div>

                <!-- ç”Ÿå¾’ä¸€è¦§ -->
                <div class="chart-container mt-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">ç”Ÿå¾’ä¸€è¦§</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr class="student-list-header">
                                    <th data-sort="name" class="p-3">ç”Ÿå¾’å</th>
                                    <th data-sort="x" class="p-3 sort-desc">ä»Šæœˆã®å­¦ç¿’æ™‚é–“</th>
                                    <th data-sort="diff_x" class="p-3">å…ˆæœˆæ¯” (æ™‚é–“)</th>
                                    <th data-sort="y" class="p-3">ä»Šæœˆã®ç¿’å¾—å˜èªæ•°</th>
                                    <th data-sort="diff_y" class="p-3">å…ˆæœˆæ¯” (å˜èª)</th>
                                </tr>
                            </thead>
                            <tbody id="student-list" class="divide-y divide-slate-200">
                                <!-- JSã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ã‚¯ãƒ©ã‚¹æŒ‡å°ãƒ¡ãƒ¢ (æ–°è¦è¿½åŠ ) -->
                <div id="class-memo-container" class="chart-container mt-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">ã‚¯ãƒ©ã‚¹æŒ‡å°ãƒ¡ãƒ¢</h3>
                    <!-- ãƒ¡ãƒ¢ã®æ“¬ä¼¼ã‚¿ãƒ– -->
                    <div class="flex border-b border-slate-200 mb-4">
                        <button id="class-memo-tab-input" class="memo-tab-button active text-sm font-medium py-2 px-4 rounded-t-lg">
                            ğŸ“ ãƒ¡ãƒ¢ã‚’å…¥åŠ›
                        </button>
                        <button id="class-memo-tab-history" class="memo-tab-button text-sm font-medium py-2 px-4 rounded-t-lg">
                            ğŸ“– ãƒ¡ãƒ¢å±¥æ­´
                        </button>
                    </div>
                    <!-- ãƒ¡ãƒ¢å…¥åŠ›æ¬„ -->
                    <div id="class-memo-input-area">
                        <textarea class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="ï¼ˆä¾‹ï¼‰1-1çµ„ã¯ã€Œè©±ã™ã€ãŒå¼·ã„ãŒã€Œæ›¸ãã€ãŒå­¦å¹´å¹³å‡ä»¥ä¸‹ã€‚æ¥é€±ã¯ãƒãƒˆãƒ«ã®ã€Œæ›¸ãã€ãƒ¢ãƒ¼ãƒ‰ã‚’æ¨å¥¨ã—ã¦ã¿ã‚ˆã†ã€‚"></textarea>
                        <button class="mt-3 bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">
                            ãƒ¡ãƒ¢ã‚’ä¿å­˜
                        </button>
                    </div>
                    <!-- ãƒ¡ãƒ¢å±¥æ­´æ¬„ (ãƒ€ãƒŸãƒ¼) -->
                    <div id="class-memo-history-area" style="display: none;">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th class="p-3 w-1/4">æ—¥ä»˜</th>
                                    <th class="p-3 w-3/4">ãƒ¡ãƒ¢å†…å®¹</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                <tr>
                                    <td class="p-3 align-top">2025/08/15</td>
                                    <td class="p-3 whitespace-pre-wrap">å¤ä¼‘ã¿æ˜ã‘ã€‚å…¨ä½“çš„ã«ã€Œèãã€ã®ã‚¹ã‚³ã‚¢ãŒä¼¸ã³ã¦ã„ã‚‹ã€‚ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ã—ã£ã‹ã‚Šé€²ã‚ãŸæ§˜å­ã€‚</td>
                                </tr>
                                 <tr>
                                    <td class="p-3 align-top">2025/08/01</td>
                                    <td class="p-3 whitespace-pre-wrap">AIè‹±ä¼šè©±ã®æ´»ç”¨ãŒã‚¯ãƒ©ã‚¹å…¨ä½“ã§ã¾ã å°‘ãªã„ã€‚å¤ä¼‘ã¿ã®èª²é¡Œã¨ã—ã¦AIè‹±ä¼šè©±ã‚’æ¯æ—¥10åˆ†æ¨å¥¨ã™ã‚‹ã€‚</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- ç”Ÿå¾’è©³ç´°ãƒ“ãƒ¥ãƒ¼ -->
            <div id="student-view" class="view-content p-4 md:p-8" style="display: none;">
                <!-- ãƒ•ã‚£ãƒ«ã‚¿ (æ–°è¦è¿½åŠ ) -->
                <div class="flex flex-wrap items-center gap-4 mb-6">
                    <div>
                        <label for="student-view-class-filter" class="text-sm font-medium text-slate-700 mr-2">ã‚¯ãƒ©ã‚¹ï¼š</label>
                        <select id="student-view-class-filter" class="rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <!-- JSã§ç”Ÿæˆ -->
                        </select>
                    </div>
                     <div>
                        <label for="student-view-student-filter" class="text-sm font-medium text-slate-700 mr-2">ç”Ÿå¾’ï¼š</label>
                        <select id="student-view-student-filter" class="rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <!-- JSã§ç”Ÿæˆ -->
                        </select>
                    </div>
                </div>

                <!-- ç”Ÿå¾’ã‚µãƒãƒªãƒ¼ (ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç§»å‹•) -->
                <div id="student-summary-content" style="display: none;"> <!-- ç”Ÿå¾’é¸æŠæ™‚ã®ã¿è¡¨ç¤º -->
                    <h2 id="student-name-header" class="text-2xl font-bold text-slate-800 mb-4"></h2>

                    <!-- 1. ç”Ÿå¾’KPIã‚µãƒãƒªãƒ¼ -->
                    <div class="grid grid-cols-2 gap-4 md:gap-6 mb-8">
                        <div class="kpi-card bg-white p-5 rounded-lg border border-slate-200">
                            <div class="text-sm font-medium text-slate-500">ä»Šæœˆã®å­¦ç¿’æ™‚é–“</div>
                            <div class="flex items-baseline mt-1">
                                <div class="text-3xl font-bold text-blue-600" id="student-kpi-time"></div>
                                <div class="text-lg font-medium ml-2" id="student-kpi-time-diff"></div>
                            </div>
                        </div>
                        <div class="kpi-card bg-white p-5 rounded-lg border border-slate-200">
                            <div class="text-sm font-medium text-slate-500">ä»Šæœˆã®ç¿’å¾—å˜èªæ•°</div>
                            <div class="flex items-baseline mt-1">
                                <div class="text-3xl font-bold text-green-600" id="student-kpi-words"></div>
                                <div class="text-lg font-medium ml-2" id="student-kpi-words-diff"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰åˆ†æ (ãƒ¬ãƒ¼ãƒ€ãƒ¼ + æ•£å¸ƒå›³ + å†…è¨³) -->
                    <div class="grid grid-cols-2 gap-4 md:gap-6 mb-8">
                        <!-- 6æŠ€èƒ½ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
                        <div class="chart-container">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">6æŠ€èƒ½ãƒãƒ©ãƒ³ã‚¹ (å€‹äºº vs ã‚¯ãƒ©ã‚¹å¹³å‡)</h3>
                            <canvas id="student-radar-chart"></canvas>
                            <p class="mt-4 text-center text-sm font-semibold text-slate-700 p-3 bg-slate-100 rounded-lg">
                                <strong class="text-blue-600">é’è‰²ï¼ˆæœ¬äººï¼‰</strong>ã¨<strong class="text-slate-500">ã‚°ãƒ¬ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¹å¹³å‡ï¼‰</strong>ã‚’æ¯”ã¹ã€å¾—æ„ãƒ»ä¸å¾—æ„ãªã‚¹ã‚­ãƒ«ã‚’æŠŠæ¡ã§ãã¾ã™ã€‚
                            </p>
                        </div>

                        <!-- å­¦ç¿’æ™‚é–“ã®å†…è¨³ -->
                        <div class="chart-container">
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">å­¦ç¿’æ™‚é–“ã®å†…è¨³ (å€‹äººã®å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«)</h3>
                            <canvas id="student-breakdown-chart"></canvas>
                            <p class="mt-4 text-center text-sm font-semibold text-slate-700 p-3 bg-slate-100 rounded-lg">
                                <strong class="text-blue-600">ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆèãï¼‰</strong>ä¸­å¿ƒã‹ã€<strong class="text-red-600">ãƒãƒˆãƒ«ï¼ˆè©±ã™ï¼‰</strong>ä¸­å¿ƒã‹ã€å­¦ç¿’ã®ã€Œåã‚Šã€ï¼ã€Œå¥½ã¿ã€ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚
                            </p>
                        </div>
                    </div>

                    <!-- ã‚¯ãƒ©ã‚¹å†…ãƒã‚¸ã‚·ãƒ§ãƒ³ -->
                    <div class="chart-container mb-8">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">ã‚¯ãƒ©ã‚¹å†…ãƒã‚¸ã‚·ãƒ§ãƒ³ (æ™‚é–“ vs å˜èª)</h3>
                        <canvas id="student-scatter-chart"></canvas>
                        <p class="mt-4 text-center text-sm font-semibold text-slate-700 p-3 bg-slate-100 rounded-lg">
                            <strong class="text-blue-600">é’ã„ç‚¹ï¼ˆæœ¬äººï¼‰</strong>ãŒã‚¯ãƒ©ã‚¹ï¼ˆã‚°ãƒ¬ãƒ¼ã®ç‚¹ï¼‰ã®ä¸­ã§ã©ã®ä½ç½®ã«ã„ã‚‹ã‹ã§ã€å­¦ç¿’ã‚¿ã‚¤ãƒ—ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚<br>
                            ï¼ˆä¾‹ï¼š<strong class="text-green-600">å³ä¸Šï¼åŠªåŠ›å‹</strong>, <strong class="text-red-600">å³ä¸‹ï¼è¦ãƒ•ã‚©ãƒ­ãƒ¼ï¼ˆæ™‚é–“â†‘å˜èªâ†“ï¼‰</strong>ï¼‰
                        </p>
                    </div>

                    <!-- ç”Ÿå¾’æŒ‡å°ãƒ¡ãƒ¢ (ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã«ç§»å‹•) -->
                    <div id="student-memo-container" class="chart-container mb-8">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">å€‹åˆ¥ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãƒ»ãƒ—ãƒ©ãƒ³</h3>
                        <!-- ãƒ¡ãƒ¢ã®æ“¬ä¼¼ã‚¿ãƒ– -->
                        <div class="flex border-b border-slate-200 mb-4">
                            <button id="student-memo-tab-input" class="memo-tab-button active text-sm font-medium py-2 px-4 rounded-t-lg">
                                ğŸ“ ãƒ¡ãƒ¢ã‚’å…¥åŠ›
                            </button>
                            <button id="student-memo-tab-history" class="memo-tab-button text-sm font-medium py-2 px-4 rounded-t-lg">
                                ğŸ“– ãƒ¡ãƒ¢å±¥æ­´
                            </button>
                        </div>
                        <!-- ãƒ¡ãƒ¢å…¥åŠ›æ¬„ -->
                        <div id="student-memo-input-area">
                            <textarea class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" rows="4" placeholder="ï¼ˆä¾‹ï¼‰å­¦ç¿’æ™‚é–“ï¼ˆå³ä¸Šï¼‰ã¯ã‚¯ãƒ©ã‚¹æœ€é•·ã ãŒã€å˜èªç¿’å¾—ãŒè¿½ã„ã¤ã„ã¦ã„ãªã„ï¼ˆå³ä¸‹ï¼‰ã€‚å†…è¨³ã‚’è¦‹ã‚‹ã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç‰¹åŒ–ï¼ˆèããƒ»èª­ã‚€ï¼‰ãŒ80%ã€‚æœ¬äººã®å¼·ã¿ã‚’èªã‚ã¤ã¤ã€ãƒãƒˆãƒ«ï¼ˆè©±ã™ãƒ»æ›¸ãï¼‰ã§ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‚’ä¿ƒã™å£°ã‹ã‘ã‚’è¡Œã†ã€‚"></textarea>
                            <button class="mt-3 bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">
                                ãƒ¡ãƒ¢ã‚’ä¿å­˜
                            </button>
                        </div>
                        <!-- ãƒ¡ãƒ¢å±¥æ­´æ¬„ (ãƒ€ãƒŸãƒ¼) -->
                        <div id="student-memo-history-area" style="display: none;">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="p-3 w-1/4">æ—¥ä»˜</th>
                                        <th class="p-3 w-3/4">ãƒ¡ãƒ¢å†…å®¹</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200">
                                    <tr>
                                        <td class="p-3 align-top">2025/08/15</td>
                                        <td class="p-3 whitespace-pre-wrap">å­¦ç¿’æ™‚é–“ãƒ»å˜èªæ•°ã¨ã‚‚ã«å…ˆæœˆæ¯”ãƒã‚¤ãƒŠã‚¹ã€‚ã€Œè¦ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã€ã€‚</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ ---

        // 4æŠ€èƒ½ã‚«ãƒ©ãƒ¼
        const SKILL_COLORS = {
            listening: 'rgba(66, 133, 244, 0.8)', // é’
            speaking: 'rgba(234, 67, 53, 0.8)', // èµ¤
            reading: 'rgba(52, 168, 83, 0.8)', // ç·‘
            writing: 'rgba(251, 188, 5, 0.8)', // é»„
            phrase: 'rgba(156, 39, 176, 0.8)', // ç´«
            ai_time: 'rgba(255, 111, 0, 0.8)', // ã‚ªãƒ¬ãƒ³ã‚¸
            goal: 'rgba(224, 224, 224, 0.7)' // ã‚°ãƒ¬ãƒ¼ (ç›®æ¨™)
        };

        // å…¨ç”Ÿå¾’ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
        const allStudentData = [
            { id: 'S001', name: 'ç”Ÿå¾’ A1', classId: '1-1', grade: '1å¹´ç”Ÿ', x: 25.5, y: 510, prev_x: 20.0, prev_y: 400, skills: { l: 150, s: 120, r: 140, w: 100 }, phrase: 50, ai_time: 120 },
            { id: 'S002', name: 'ç”Ÿå¾’ A2', classId: '1-1', grade: '1å¹´ç”Ÿ', x: 22.0, y: 450, prev_x: 21.0, prev_y: 410, skills: { l: 120, s: 110, r: 120, w: 100 }, phrase: 45, ai_time: 110 },
            { id: 'S003', name: 'ç”Ÿå¾’ A3', classId: '1-1', grade: '1å¹´ç”Ÿ', x: 18.0, y: 380, prev_x: 19.0, prev_y: 390, skills: { l: 100, s: 90, r: 100, w: 90 }, phrase: 40, ai_time: 100 },
            { id: 'S004', name: 'ç”Ÿå¾’ A4', classId: '1-1', grade: '1å¹´ç”Ÿ', x: 5.0, y: 100, prev_x: 8.0, prev_y: 150, skills: { l: 30, s: 20, r: 30, w: 20 }, phrase: 10, ai_time: 30 },
            { id: 'S005', name: 'ç”Ÿå¾’ B1', classId: '1-2', grade: '1å¹´ç”Ÿ', x: 15.0, y: 300, prev_x: 14.0, prev_y: 280, skills: { l: 80, s: 70, r: 90, w: 60 }, phrase: 30, ai_time: 80 },
            { id: 'S006', name: 'ç”Ÿå¾’ B2', classId: '1-2', grade: '1å¹´ç”Ÿ', x: 12.0, y: 250, prev_x: 10.0, prev_y: 200, skills: { l: 70, s: 60, r: 70, w: 50 }, phrase: 25, ai_time: 70 },
            { id: 'S007', name: 'ç”Ÿå¾’ C1', classId: '2-1', grade: '2å¹´ç”Ÿ', x: 20.0, y: 420, prev_x: 18.0, prev_y: 380, skills: { l: 110, s: 100, r: 110, w: 100 }, phrase: 42, ai_time: 115 },
            { id: 'S008', name: 'ç”Ÿå¾’ C2', classId: '2-1', grade: '2å¹´ç”Ÿ', x: 17.0, y: 350, prev_x: 17.5, prev_y: 360, skills: { l: 90, s: 80, r: 90, w: 90 }, phrase: 35, ai_time: 90 },
            { id: 'S009', name: 'ç”Ÿå¾’ D1', classId: '3-1', grade: '3å¹´ç”Ÿ', x: 30.0, y: 600, prev_x: 25.0, prev_y: 500, skills: { l: 180, s: 150, r: 170, w: 100 }, phrase: 60, ai_time: 150 },
            { id: 'S010', name: 'ç”Ÿå¾’ D2', classId: '3-1', grade: '3å¹´ç”Ÿ', x: 3.0, y: 65, prev_x: 3.5, prev_y: 70, skills: { l: 20, s: 10, r: 20, w: 15 }, phrase: 5, ai_time: 10 },
        ];

        const allClassData = [
            { id: '1-1', name: '1å¹´1çµ„' },
            { id: '1-2', name: '1å¹´2çµ„' },
            { id: '2-1', name: '2å¹´1çµ„' },
            { id: '3-1', name: '3å¹´1çµ„' }
        ];

        // ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
        const charts = {
            kpiWords: null,
            comparisonBar: null,
            breakdown: null,
            skillBar: null,
            timeSeries: null,
            // ç”Ÿå¾’è©³ç´°ã‚°ãƒ©ãƒ•
            studentRadar: null,
            studentScatter: null,
            studentBreakdown: null
        };

        let currentStudentId = null; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”Ÿå¾’ID

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        // å¹³å‡ã‚’è¨ˆç®—
        function getAverage(data, key) {
            if (!data || data.length === 0) return 0;
            const total = data.reduce((sum, item) => sum + item[key], 0);
            return total / data.length;
        }

        // 4æŠ€èƒ½ã®åˆè¨ˆ/å¹³å‡ã‚’è¨ˆç®— (ãƒã‚¹ãƒˆå¯¾å¿œ)
        function getSkillAverage(data, dataKey) {
             if (!data || data.length === 0) return 0;
             let total = 0;
             if (dataKey.includes('.')) {
                const [key1, key2] = dataKey.split('.');
                total = data.reduce((sum, item) => sum + (item[key1] ? item[key1][key2] : 0), 0);
             } else {
                total = data.reduce((sum, item) => sum + (item[dataKey] ? item[dataKey] : 0), 0);
             }
             return total / data.length;
        }


        // --- å­¦æ ¡å…¨ä½“ãƒ“ãƒ¥ãƒ¼ ---

        // 1. KPI å˜èªæ•°ãƒ‰ãƒ¼ãƒŠãƒ„
        function createKpiWordsChart(filteredData) {
            const avgWords = getAverage(filteredData, 'y');
            const goal = 1800; // ä¸­å­¦3å¹´ç›®æ¨™
            const percentage = (avgWords / goal) * 100;
            const remaining = 100 - percentage;

            document.getElementById('kpi-words-text').textContent = `${percentage.toFixed(0)}%`;

            const ctx = document.getElementById('kpi-words-chart').getContext('2d');
            if (charts.kpiWords) charts.kpiWords.destroy();
            charts.kpiWords = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remaining > 0 ? remaining : 0],
                        backgroundColor: [SKILL_COLORS.reading, SKILL_COLORS.goal],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        // 2. å­¦ç¿’åŠ¹æœ (æœ€çŸ­ vs æœ€é•·) æ£’ã‚°ãƒ©ãƒ•
        function createComparisonBarChart(filteredData) {
            if (!filteredData || filteredData.length === 0) {
                 if (charts.comparisonBar) charts.comparisonBar.destroy(); // ãƒ‡ãƒ¼ã‚¿ãªã„å ´åˆã¯ã‚¯ãƒªã‚¢
                return;
            }

            const sorted = [...filteredData].sort((a, b) => a.x - b.x);
            const minStudent = sorted[0];
            const maxStudent = sorted[sorted.length - 1];

            if (!minStudent || !maxStudent) return; // ãƒ‡ãƒ¼ã‚¿ä¸è¶³

            const ctx = document.getElementById('comparison-bar-chart').getContext('2d');
            if (charts.comparisonBar) charts.comparisonBar.destroy();
            charts.comparisonBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ãƒ—ãƒ¬ãƒ¼æ™‚é–“', 'ç¿’å¾—å˜èªæ•°'], // â˜… Xè»¸ã®ãƒ©ãƒ™ãƒ«
                    datasets: [
                        {
                            label: `æœ€çŸ­ç”Ÿå¾’ (æœˆ${minStudent.x.toFixed(1)}h)`,
                            data: [minStudent.x, minStudent.y],
                            backgroundColor: 'rgba(107, 114, 128, 0.7)', // Gray
                            borderColor: 'rgba(107, 114, 128, 1)',
                            borderWidth: 1
                        },
                        {
                            label: `æœ€é•·ç”Ÿå¾’ (æœˆ${maxStudent.x.toFixed(1)}h)`,
                            data: [maxStudent.x, maxStudent.y],
                            backgroundColor: 'rgba(59, 130, 246, 0.7)', // Blue
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    // indexAxis: 'y', // â˜…â˜…â˜… å‰Šé™¤ã—ã¾ã—ãŸ â˜…â˜…â˜…
                    scales: {
                        x: { beginAtZero: true }, // Xè»¸
                        y: { beginAtZero: true }  // Yè»¸
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { enabled: false } // ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ç„¡åŠ¹åŒ–
                    }
                }
            });

            // â˜… çµè«–ãƒ†ã‚­ã‚¹ãƒˆã¯å¤‰æ›´ã—ãªã„
            const conclusionEl = document.getElementById('comparison-bar-chart').closest('.chart-container').querySelector('p');
            if (conclusionEl) {
                const ratio = (maxStudent.y / minStudent.y) || 0;
                 conclusionEl.innerHTML = `
                    ãƒ—ãƒ¬ãƒ¼æ™‚é–“ãŒ<strong class="text-blue-600">æœ€é•·ã®ç”Ÿå¾’</strong>ã¯ã€<strong class="text-slate-500">æœ€çŸ­ã®ç”Ÿå¾’</strong>ã«æ¯”ã¹ã€<strong class="text-green-600">å˜èªç¿’å¾—æ•°ãŒç´„${ratio.toFixed(1)}å€</strong>ã«å¢—åŠ ã—ã¦ã„ã¾ã™ã€‚
                 `;
            }
        }

        // 3. å­¦ç¿’å†…è¨³ãƒ‰ãƒ¼ãƒŠãƒ„ (å­¦æ ¡/å­¦å¹´)
        function createBreakdownChart(filteredData) {
             if (!filteredData || filteredData.length === 0) {
                 if (charts.breakdown) charts.breakdown.destroy(); // ãƒ‡ãƒ¼ã‚¿ãªã„å ´åˆã¯ã‚¯ãƒªã‚¢
                return;
            }

            // ãƒ€ãƒŸãƒ¼ã®å†…è¨³ãƒ‡ãƒ¼ã‚¿
            const l_r_total = filteredData.reduce((sum, s) => sum + s.skills.l + s.skills.r, 0);
            const s_w_total = filteredData.reduce((sum, s) => sum + s.skills.s + s.skills.w, 0);
            const phrase_total = filteredData.reduce((sum, s) => sum + s.phrase, 0);

            const total = l_r_total + s_w_total + phrase_total;

            // ã‚¼ãƒ­é™¤ç®—ã‚’å›é¿
            const data = (total === 0) ? [0, 0, 0] : [
                (l_r_total / total) * 100,
                (s_w_total / total) * 100,
                (phrase_total / total) * 100
            ];

            const ctx = document.getElementById('breakdown-chart').getContext('2d');
            if (charts.breakdown) charts.breakdown.destroy();
            charts.breakdown = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ (èããƒ»èª­ã‚€)', 'ãƒãƒˆãƒ« (è©±ã™ãƒ»æ›¸ã)', 'å˜èªãƒ»ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ»AIè‹±ä¼šè©±'],
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            SKILL_COLORS.listening,
                            SKILL_COLORS.speaking,
                            SKILL_COLORS.phrase
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 4. ãƒˆãƒƒãƒ—1ã‚¯ãƒ©ã‚¹ã‚°ãƒªãƒƒãƒ‰
        function renderTop1Grid(data) {
            const grid = document.getElementById('top-class-grid');
            if (!grid) return;
            grid.innerHTML = ''; // ã‚¯ãƒªã‚¢

            const metrics = [
                { key: 'listening', name: 'èã (å˜èª)', color: SKILL_COLORS.listening, unit: 'å˜èª', dataKey: 'skills.l' },
                { key: 'speaking', name: 'è©±ã™ (å˜èª)', color: SKILL_COLORS.speaking, unit: 'å˜èª', dataKey: 'skills.s' },
                { key: 'reading', name: 'èª­ã‚€ (å˜èª)', color: SKILL_COLORS.reading, unit: 'å˜èª', dataKey: 'skills.r' },
                { key: 'writing', name: 'æ›¸ã (å˜èª)', color: SKILL_COLORS.writing, unit: 'å˜èª', dataKey: 'skills.w' },
                { key: 'phrase', name: 'ãƒ•ãƒ¬ãƒ¼ã‚º', color: SKILL_COLORS.phrase, unit: 'ãƒ•ãƒ¬ãƒ¼ã‚º', dataKey: 'phrase' },
                { key: 'ai_time', name: 'AIä¼šè©±æ™‚é–“', color: SKILL_COLORS.ai_time, unit: 'åˆ†', dataKey: 'ai_time' },
            ];

            const classes = [...new Set(data.map(s => s.classId))];

            metrics.forEach(metric => {
                if (!data || data.length === 0 || classes.length === 0) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

                const classAvgs = classes.map(classId => {
                    const classData = data.filter(s => s.classId === classId);
                    const avg = getSkillAverage(classData, metric.dataKey);
                    return { classId, avg };
                }).sort((a, b) => b.avg - a.avg);

                const top1 = classAvgs[0];
                if (!top1) return; // ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿ãªã—

                const card = document.createElement('div');
                card.className = 'top-class-card bg-white p-4 rounded-lg border border-slate-200';
                card.style.borderColor = metric.color;
                card.dataset.classId = top1.classId; // ã‚¯ãƒªãƒƒã‚¯é·ç§»ç”¨ã®ãƒ‡ãƒ¼ã‚¿

                card.innerHTML = `
                    <div class="text-sm font-semibold" style="color: ${metric.color};">${metric.name} No.1</div>
                    <div class="mt-2">
                        <div class="text-2xl font-bold text-slate-800">${top1.classId.replace('-', 'å¹´')}çµ„</div>
                        <div class="text-sm text-slate-500">å¹³å‡ ${top1.avg.toFixed(0)} ${metric.unit}</div>
                    </div>
                    <div class="text-xs text-blue-600 font-semibold mt-2">
                        ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°åˆ†æ &rarr;
                    </div>
                `;
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                card.addEventListener('click', () => {
                    document.getElementById('class-filter').value = top1.classId;
                    showView('class');
                });
                grid.appendChild(card);
            });
        }

        // --- ã‚¯ãƒ©ã‚¹è©³ç´°ãƒ“ãƒ¥ãƒ¼ ---

        // 5. 4æŠ€èƒ½ãƒãƒ©ãƒ³ã‚¹ (æ£’ã‚°ãƒ©ãƒ•)
        function createSkillBarChart(selectedClass) {
            const grade = selectedClass.split('-')[0] + 'å¹´ç”Ÿ';

            const classData = allStudentData.filter(s => s.classId === selectedClass);
            const gradeData = allStudentData.filter(s => s.grade === grade);

            const skills = ['l', 's', 'r', 'w'];
            const labels = ['èã', 'è©±ã™', 'èª­ã‚€', 'æ›¸ã'];

            const classAvgs = skills.map(skill => getSkillAverage(classData, `skills.${skill}`));
            const gradeAvgs = skills.map(skill => getSkillAverage(gradeData, `skills.${skill}`));

            const ctx = document.getElementById('skill-bar-chart').getContext('2d');
            if (charts.skillBar) charts.skillBar.destroy();
            charts.skillBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `ã‚¯ãƒ©ã‚¹å¹³å‡ (${selectedClass.replace('-', 'å¹´')}çµ„)`,
                            data: classAvgs,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        },
                        {
                            label: `å­¦å¹´å¹³å‡ (${grade})`,
                            data: gradeAvgs,
                            backgroundColor: 'rgba(209, 213, 219, 0.7)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // 6. æ™‚ç³»åˆ—æ¨ç§» (ãƒ€ãƒŸãƒ¼)
        function createTimeSeriesChart() {
            const ctx = document.getElementById('time-series-chart').getContext('2d');
            if (charts.timeSeries) charts.timeSeries.destroy();
            charts.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ'],
                    datasets: [
                        { label: 'èã', data: [50, 60, 80, 100], borderColor: SKILL_COLORS.listening, fill: false, tension: 0.1 },
                        { label: 'è©±ã™', data: [40, 50, 65, 90], borderColor: SKILL_COLORS.speaking, fill: false, tension: 0.1 },
                        { label: 'èª­ã‚€', data: [45, 55, 70, 95], borderColor: SKILL_COLORS.reading, fill: false, tension: 0.1 },
                        { label: 'æ›¸ã', data: [30, 40, 50, 70], borderColor: SKILL_COLORS.writing, fill: false, tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // 7. ç”Ÿå¾’ãƒªã‚¹ãƒˆ
        function renderStudentList(selectedClass, sortKey, sortOrder) {
            const listBody = document.getElementById('student-list');
            if (!listBody) return;

            const classStudents = allStudentData
                .filter(s => s.classId === selectedClass)
                .map(s => ({
                    ...s,
                    diff_x: s.x - s.prev_x,
                    diff_y: s.y - s.prev_y
                }));

            // ã‚½ãƒ¼ãƒˆ
            classStudents.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];
                if (sortKey === 'name') {
                    return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return sortOrder === 'asc' ? valA - valB : valB - valA;
            });

            listBody.innerHTML = ''; // ã‚¯ãƒªã‚¢

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚½ãƒ¼ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
            document.querySelectorAll('.student-list-header th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === sortKey) {
                    th.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            // è¡Œã‚’ç”Ÿæˆ
            classStudents.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                row.dataset.studentId = student.id; // ç”Ÿå¾’IDã‚’ã‚»ãƒƒãƒˆ

                // å…ˆæœˆæ¯” (æ™‚é–“)
                const diffX = student.diff_x;
                const diffXIcon = diffX >= 0 ? `<span class="text-green-600">â†—</span>` : `<span class="text-red-600">â†˜</span>`;
                const diffXColor = diffX >= 0 ? 'text-green-600' : 'text-red-600';

                // å…ˆæœˆæ¯” (å˜èª)
                const diffY = student.diff_y;
                const diffYIcon = diffY >= 0 ? `<span class="text-green-600">â†—</span>` : `<span class="text-red-600">â†˜</span>`;
                const diffYColor = diffY >= 0 ? 'text-green-600' : 'text-red-600';

                row.innerHTML = `
                    <td class="p-3 font-medium text-slate-900">${student.name}</td>
                    <td class="p-3">
                        <div class="font-medium">${student.x.toFixed(1)}h</div>
                        <div class="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                            <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${Math.min(100, (student.x / 30) * 100)}%"></div>
                        </div>
                    </td>
                    <td class="p-3 ${diffXColor} font-medium">
                        ${diffXIcon} ${diffX >= 0 ? '+' : ''}${diffX.toFixed(1)}h
                    </td>
                    <td class="p-3">
                        <div class="font-medium">${student.y.toFixed(0)}èª</div>
                        <div class="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                            <div class="bg-green-600 h-1.5 rounded-full" style="width: ${Math.min(100, (student.y / 600) * 100)}%"></div>
                        </div>
                    </td>
                    <td class="p-3 ${diffYColor} font-medium">
                        ${diffYIcon} ${diffY >= 0 ? '+' : ''}${diffY.toFixed(0)}èª
                    </td>
                `;

                // è¡Œã‚¯ãƒªãƒƒã‚¯ã§ç”Ÿå¾’è©³ç´°ãƒ“ãƒ¥ãƒ¼ã¸ (ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£)
                row.addEventListener('click', () => {
                    const student = allStudentData.find(s => s.id === row.dataset.studentId);
                    if (!student) return;

                    // 1. Set class filter
                    document.getElementById('student-view-class-filter').value = student.classId;
                    // 2. Populate student filter
                    populateStudentFilter(student.classId);
                    // 3. Set student filter
                    document.getElementById('student-view-student-filter').value = student.id;

                    // 4. Switch view
                    showView('student');
                });

                listBody.appendChild(row);
            });
        }

        // --- ç”Ÿå¾’è©³ç´°ãƒ“ãƒ¥ãƒ¼ ---

        // 8. ç”Ÿå¾’è©³ç´° 6æŠ€èƒ½ãƒ¬ãƒ¼ãƒ€ãƒ¼
        function createStudentRadarChart(student, classData) {
            const labels = ['èã(å˜èª)', 'è©±ã™(å˜èª)', 'èª­ã‚€(å˜èª)', 'æ›¸ã(å˜èª)', 'ãƒ•ãƒ¬ãƒ¼ã‚º', 'AIä¼šè©±(åˆ†)'];
            const keys = ['skills.l', 'skills.s', 'skills.r', 'skills.w', 'phrase', 'ai_time'];

            // æœ€å¤§å€¤ã®è¨ˆç®—ï¼ˆã‚¯ãƒ©ã‚¹å¹³å‡ã¨å€‹äººã®æœ€å¤§å€¤ï¼‰
            const maxValues = keys.map(key => {
                const classAvg = getSkillAverage(classData, key);
                const studentVal = key.includes('.') ? (student.skills[key.split('.')[1]] || 0) : (student[key] || 0);
                return Math.max(classAvg, studentVal);
            });
            // ã‚°ãƒ©ãƒ•ã®è¦‹ãŸç›®ã®ãŸã‚ã«ã€æœ€å¤§å€¤ã«å°‘ã—ãƒãƒ¼ã‚¸ãƒ³ã‚’æŒãŸã›ã‚‹
            const suggestedMax = Math.max(...maxValues) * 1.2;

            const studentValues = keys.map(key => key.includes('.') ? (student.skills[key.split('.')[1]] || 0) : (student[key] || 0));
            const classAvgValues = keys.map(key => getSkillAverage(classData, key));

            const ctx = document.getElementById('student-radar-chart').getContext('2d');
            if (charts.studentRadar) charts.studentRadar.destroy();
            charts.studentRadar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æœ¬äºº',
                            data: studentValues,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)'
                        },
                        {
                            label: 'ã‚¯ãƒ©ã‚¹å¹³å‡',
                            data: classAvgValues,
                            backgroundColor: 'rgba(107, 114, 128, 0.2)',
                            borderColor: 'rgba(107, 114, 128, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(107, 114, 128, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax > 0 ? suggestedMax : 10 // 0é™¤ç®—ã‚’é¿ã‘ã‚‹
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // 9. ç”Ÿå¾’è©³ç´° ã‚¯ãƒ©ã‚¹å†…ãƒã‚¸ã‚·ãƒ§ãƒ³ (æ•£å¸ƒå›³)
        function createStudentScatterChart(student, classData) {
            const ctx = document.getElementById('student-scatter-chart').getContext('2d');

            const classPoints = classData.map(s => ({
                x: s.x,
                y: s.y,
                label: s.name
            }));

            const studentPoint = {
                x: student.x,
                y: student.y,
                label: student.name
            };

            if (charts.studentScatter) charts.studentScatter.destroy();
            charts.studentScatter = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'ã‚¯ãƒ©ã‚¹ãƒ¡ã‚¤ãƒˆ',
                            data: classPoints.filter(s => s.label !== student.name), // æœ¬äººã‚’é™¤ã
                            backgroundColor: 'rgba(107, 114, 128, 0.5)',
                            pointRadius: 6,
                        },
                        {
                            label: 'æœ¬äºº',
                            data: [studentPoint],
                            backgroundColor: 'rgba(59, 130, 246, 0.9)',
                            pointRadius: 10, // æœ¬äººã‚’ç›®ç«‹ãŸã›ã‚‹
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'ä»Šæœˆã®å­¦ç¿’æ™‚é–“ (h)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'ä»Šæœˆã®ç¿’å¾—å˜èªæ•° (èª)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    return `${context.raw.label}: (${context.raw.x}h, ${context.raw.y}èª)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 10. ç”Ÿå¾’è©³ç´° å­¦ç¿’å†…è¨³ (ãƒ‰ãƒ¼ãƒŠãƒ„)
        function createStudentBreakdownChart(student) {
             const filteredData = [student]; // ã“ã®ç”Ÿå¾’ä¸€äººã®ãƒ‡ãƒ¼ã‚¿

             const l_r_total = filteredData.reduce((sum, s) => sum + s.skills.l + s.skills.r, 0);
             const s_w_total = filteredData.reduce((sum, s) => sum + s.skills.s + s.skills.w, 0);
             const phrase_total = filteredData.reduce((sum, s) => sum + s.phrase, 0);

             const total = l_r_total + s_w_total + phrase_total;

             const data = (total === 0) ? [0, 0, 0] : [
                 (l_r_total / total) * 100,
                 (s_w_total / total) * 100,
                 (phrase_total / total) * 100
             ];

             const ctx = document.getElementById('student-breakdown-chart').getContext('2d');
             if (charts.studentBreakdown) charts.studentBreakdown.destroy();
             charts.studentBreakdown = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: ['ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ (èããƒ»èª­ã‚€)', 'ãƒãƒˆãƒ« (è©±ã™ãƒ»æ›¸ã)', 'å˜èªãƒ»ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ»AIè‹±ä¼šè©±'],
                     datasets: [{
                         data: data,
                         backgroundColor: [
                             SKILL_COLORS.listening,
                             SKILL_COLORS.speaking,
                             SKILL_COLORS.phrase
                         ],
                         borderColor: '#ffffff',
                         borderWidth: 2
                     }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         legend: { position: 'bottom' },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     return `${context.label}: ${context.raw.toFixed(1)}%`;
                                 }
                             }
                         }
                     }
                 }
             });
        }

        // 11. ç”Ÿå¾’è©³ç´°ãƒ“ãƒ¥ãƒ¼ã®ã€Œæç”»ã€ãƒ­ã‚¸ãƒƒã‚¯ (æ”¹å)
        function renderStudentViewContent(student) {
            if (!student) {
                 document.getElementById('student-summary-content').style.display = 'none';
                 currentStudentId = null;
                 return;
            }

            document.getElementById('student-summary-content').style.display = 'block';
            currentStudentId = student.id;

            // 2. ã‚µãƒãƒªãƒ¼æƒ…å ±ã®è¨­å®š
            document.getElementById('student-name-header').textContent = student.name;

            // KPI
            document.getElementById('student-kpi-time').textContent = `${student.x.toFixed(1)}h`;
            document.getElementById('student-kpi-words').textContent = `${student.y.toFixed(0)}èª`;

            // KPI å…ˆæœˆæ¯” (æ™‚é–“)
            const diffX = student.x - student.prev_x;
            const diffXEl = document.getElementById('student-kpi-time-diff');
            diffXEl.textContent = `(${diffX >= 0 ? 'â†— +' : 'â†˜ '}${diffX.toFixed(1)}h)`;
            diffXEl.className = `text-lg font-medium ml-2 ${diffX >= 0 ? 'text-green-600' : 'text-red-600'}`;

            // KPI å…ˆæœˆæ¯” (å˜èª)
            const diffY = student.y - student.prev_y;
            const diffYEl = document.getElementById('student-kpi-words-diff');
            diffYEl.textContent = `(${diffY >= 0 ? 'â†— +' : 'â†˜ '}${diffY.toFixed(0)}èª)`;
            diffYEl.className = `text-lg font-medium ml-2 ${diffY >= 0 ? 'text-green-600' : 'text-red-600'}`;

            // 3. ã‚°ãƒ©ãƒ•æç”»
            const classData = allStudentData.filter(s => s.classId === student.classId);
            createStudentRadarChart(student, classData);
            createStudentScatterChart(student, classData);
            createStudentBreakdownChart(student);

            // 4. ãƒ¡ãƒ¢ã‚¿ãƒ–ã‚’ã€Œå…¥åŠ›ã€ã«ãƒªã‚»ãƒƒãƒˆ
            switchMemoTab('student', 'input');
        }

        // --- ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°ãƒ»åˆ‡ã‚Šæ›¿ãˆ ---

        // å­¦æ ¡å…¨ä½“ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function updateSchoolView() {
            const selectedGrade = document.getElementById('grade-filter').value;
            const filteredData = (selectedGrade === 'all')
                ? allStudentData
                : allStudentData.filter(s => s.grade === selectedGrade);

            // KPIã‚«ãƒ¼ãƒ‰
            const avgTime = getAverage(filteredData, 'x');
            const avgSpeaking = getAverage(filteredData, 'ai_time');
            document.getElementById('kpi-time').textContent = `${avgTime.toFixed(1)}h`;
            document.getElementById('kpi-speaking').textContent = `${avgSpeaking.toFixed(0)} åˆ†`;

            // ã‚°ãƒ©ãƒ•
            createKpiWordsChart(filteredData);
            createComparisonBarChart(filteredData);
            createBreakdownChart(filteredData);
            renderTop1Grid(filteredData);
        }

        // ã‚¯ãƒ©ã‚¹è©³ç´°ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        function updateClassView() {
            const selectedClass = document.getElementById('class-filter').value;

            createSkillBarChart(selectedClass);
            createTimeSeriesChart(); // ã“ã‚Œã¯ç¾åœ¨ãƒ€ãƒŸãƒ¼
            renderStudentList(selectedClass, 'x', 'desc'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å­¦ç¿’æ™‚é–“ã§é™é †

            // ç”Ÿå¾’è©³ç´°ã®ã‚¯ãƒ©ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ã‚‚åŒæœŸ
            document.getElementById('student-view-class-filter').value = selectedClass;
            populateStudentFilter(selectedClass);

            // ãƒ¡ãƒ¢ã‚¿ãƒ–ã‚’ã€Œå…¥åŠ›ã€ã«ãƒªã‚»ãƒƒãƒˆ
            switchMemoTab('class', 'input');
        }

        // ç”Ÿå¾’è©³ç´°ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿå¾’ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
        function populateStudentFilter(selectedClass) {
            const studentFilter = document.getElementById('student-view-student-filter');
            studentFilter.innerHTML = '<option value="">ç”Ÿå¾’ã‚’é¸æŠ...</option>'; // åˆæœŸåŒ–

            allStudentData
                .filter(s => s.classId === selectedClass)
                .forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    studentFilter.appendChild(option);
                });
        }

        // ç”Ÿå¾’è©³ç´°ãƒ“ãƒ¥ãƒ¼ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–° (ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£)
        function updateStudentView() {
            const selectedStudentId = document.getElementById('student-view-student-filter').value;
            if (selectedStudentId) {
                const student = allStudentData.find(s => s.id === selectedStudentId);
                renderStudentViewContent(student); // æç”»é–¢æ•°ã‚’å‘¼ã¶
            } else {
                renderStudentViewContent(null); // ç”Ÿå¾’æœªé¸æŠãªã‚‰éè¡¨ç¤º
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ (ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£)
        function showView(viewName) {
            document.getElementById('school-view').style.display = (viewName === 'school') ? 'block' : 'none';
            document.getElementById('class-view').style.display = (viewName === 'class') ? 'block' : 'none';
            document.getElementById('student-view').style.display = (viewName === 'student') ? 'block' : 'none';

            document.getElementById('school-tab').classList.toggle('active', viewName === 'school');
            document.getElementById('class-tab').classList.toggle('active', viewName === 'class');
            document.getElementById('student-tab').classList.toggle('active', viewName === 'student');

            // ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            if (viewName === 'school') {
                updateSchoolView();
            } else if (viewName === 'class') {
                updateClassView();
            } else if (viewName === 'student') {
                // (â˜…ä¿®æ­£ç®‡æ‰€)
                const studentClassFilter = document.getElementById('student-view-class-filter');
                const studentFilter = document.getElementById('student-view-student-filter');

                let selectedClass = studentClassFilter.value;

                // ã‚¯ãƒ©ã‚¹ãŒæœªé¸æŠã®å ´åˆï¼ˆä¾‹ï¼šåˆå›èª­ã¿è¾¼ã¿æ™‚ï¼‰ã€ã‚¯ãƒ©ã‚¹è©³ç´°ã‚¿ãƒ–ã®å€¤ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã™ã‚‹
                if (!selectedClass) {
                     selectedClass = document.getElementById('class-filter').value;
                     studentClassFilter.value = selectedClass;
                }

                // ç”Ÿå¾’ãƒ•ã‚£ãƒ«ã‚¿ã®ä¸­èº«ãŒç©ºã®å ´åˆï¼ˆä¾‹ï¼šã‚¯ãƒ©ã‚¹ãŒä»Šè¨­å®šã•ã‚ŒãŸï¼‰ã€ä¸­èº«ã‚’åŸ‹ã‚ã‚‹
                if (studentFilter.options.length <= 1) { // 1 = "ç”Ÿå¾’ã‚’é¸æŠ..."
                    populateStudentFilter(selectedClass);
                }

                // ç”Ÿå¾’ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒªã‚¹ãƒˆã®æœ€åˆã®ç”Ÿå¾’ã‚’è‡ªå‹•ã§é¸æŠã™ã‚‹
                if (!studentFilter.value && studentFilter.options.length > 1) {
                    studentFilter.value = studentFilter.options[1].value; // æœ€åˆã®ç”Ÿå¾’ã‚’é¸æŠ
                }

                updateStudentView(); // ãƒ•ã‚£ãƒ«ã‚¿ã«åŸºã¥ã„ã¦è¡¨ç¤ºã‚’æ›´æ–°
            }
        }

        // ãƒ¡ãƒ¢ã®æ“¬ä¼¼ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchMemoTab(view, tabName) { // view = 'class' or 'student'
            const inputArea = document.getElementById(`${view}-memo-input-area`);
            const historyArea = document.getElementById(`${view}-memo-history-area`);
            const inputTab = document.getElementById(`${view}-memo-tab-input`);
            const historyTab = document.getElementById(`${view}-memo-tab-history`);

            if (tabName === 'input') {
                inputArea.style.display = 'block';
                historyArea.style.display = 'none';
                inputTab.classList.add('active');
                historyTab.classList.remove('active');
            } else {
                inputArea.style.display = 'none';
                historyArea.style.display = 'block';
                inputTab.classList.remove('active');
                historyTab.classList.add('active');
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸåŒ–
            const classFilter = document.getElementById('student-view-class-filter');
            allClassData.forEach(c => {
                 const option = document.createElement('option');
                 option.value = c.id;
                 option.textContent = c.name;
                 classFilter.appendChild(option);
            });
            // â˜…ä¿®æ­£ï¼šåˆæœŸèª­ã¿è¾¼ã¿æ™‚ã«ç”Ÿå¾’ãƒ•ã‚£ãƒ«ã‚¿ã‚‚ï¼ˆæœ€åˆã®ã‚¯ãƒ©ã‚¹ã‚’å…ƒã«ï¼‰åŸ‹ã‚ã¦ãŠã
            if (allClassData.length > 0) {
                populateStudentFilter(allClassData[0].id);
            }

            // åˆæœŸè¡¨ç¤º
            showView('school');

            // ã‚¿ãƒ–ã®ã‚¯ãƒªãƒƒã‚¯
            document.getElementById('school-tab').addEventListener('click', () => showView('school'));
            document.getElementById('class-tab').addEventListener('click', () => showView('class'));
            document.getElementById('student-tab').addEventListener('click', () => showView('student'));

            // å­¦æ ¡å…¨ä½“ãƒ»ã‚¯ãƒ©ã‚¹è©³ç´° ãƒ•ã‚£ãƒ«ã‚¿ã®å¤‰æ›´
            document.getElementById('grade-filter').addEventListener('change', updateSchoolView);
            document.getElementById('class-filter').addEventListener('change', updateClassView);

            // ç”Ÿå¾’è©³ç´° ãƒ•ã‚£ãƒ«ã‚¿ã®å¤‰æ›´
            document.getElementById('student-view-class-filter').addEventListener('change', (e) => {
                populateStudentFilter(e.target.value);
                updateStudentView(); // ã‚¯ãƒ©ã‚¹å¤‰æ›´æ™‚ã¯ç”Ÿå¾’æœªé¸æŠçŠ¶æ…‹ã«æˆ»ã™
            });
            document.getElementById('student-view-student-filter').addEventListener('change', updateStudentView);

            // ç”Ÿå¾’ãƒªã‚¹ãƒˆã®ã‚½ãƒ¼ãƒˆ
            document.querySelectorAll('.student-list-header th').forEach(th => {
                th.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sortKey = th.dataset.sort;
                    if (!sortKey) return;
                    const currentOrder = th.classList.contains('sort-desc') ? 'desc' : 'asc';
                    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    const selectedClass = document.getElementById('class-filter').value;
                    renderStudentList(selectedClass, sortKey, newOrder);
                });
            });

            // ãƒ¡ãƒ¢ã‚¿ãƒ–ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('class-memo-tab-input').addEventListener('click', () => switchMemoTab('class', 'input'));
            document.getElementById('class-memo-tab-history').addEventListener('click', () => switchMemoTab('class', 'history'));
            document.getElementById('student-memo-tab-input').addEventListener('click', () => switchMemoTab('student', 'input'));
            document.getElementById('student-memo-tab-history').addEventListener('click', () => switchMemoTab('student', 'history'));
        });

    </script>
</body>
</html>
