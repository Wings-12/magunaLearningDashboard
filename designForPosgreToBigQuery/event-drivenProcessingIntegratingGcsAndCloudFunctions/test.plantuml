@startuml
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

title データ連携パイプライン設計案

participant "さくらのクラウド\n(**Node.js** スクリプト)" as SakuraCloud
note right of SakuraCloud
  **責務:**
  ・PostgreSQLから生の学習データを抽出
  ・JSON形式に変換
  ・GCSへのアップロード

  **担当範囲:**
  データ収集〜GCS投入まで
end note

participant "Google Cloud Storage\n(GCSバケット)" as GCS #LightGreen
note right of GCS #LightGreen
  **責務:**
  ・データの一時保管
  ・処理状態の管理（incoming/error/archive）
  ・ライフサイクル管理

  **役割別バケット（作成済み）:**
  ✅ incoming (データ投入用)
  ✅ error (エラーファイル隔離用)
  ✅ archive (処理済みファイル保管用)

  **設計のポイント:**
  ・最小権限の原則（セキュリティ）
  ・ライフサイクル管理（コスト最適化）
  ・運用の明確性（ヒューマンエラー防止）
end note

participant "Cloud Functions\n(**Python**)" as CloudFunctions
note right of CloudFunctions
  **責務:**
  ・JSONデータの変換・検証
  ・エラーハンドリング
  ・BigQueryへのロード制御

  **担当範囲:**
  データ変換〜BigQuery投入まで
end note

participant "Google BigQuery\n(テーブル/プロシージャ/ビュー)" as BigQuery
note right of BigQuery
  **責務:**
  ・生データの保管
  ・データの集計・整形
  ・アクセス権限制御（RLS）
  ・Looker Studio向けデータ提供

  **担当範囲:**
  データ保管〜可視化用データ整形まで
end note

participant "Cloud Scheduler" as Scheduler #WhiteSmoke
note right of Scheduler
  **責務:**
  ・定期実行の制御
  ・BigQueryプロシージャの起動
  ・実行ログの記録

  **なぜCloud Schedulerを使うのか:**
  ・GCPネイティブでBigQueryと連携が容易
  ・cron文法をサポート（移行が簡単）
  ・実行履歴・ログが自動記録される
  ・リトライ・エラー通知が標準機能
  ・サーバー不要（フルマネージド）
end note

participant "Looker Studio" as Looker #WhiteSmoke
note right of Looker
  **責務:**
  ・ダッシュボードの表示
  ・ユーザー認証
  ・グラフ・レポートの描画

  **担当範囲:**
  データ可視化のみ
  （集計・権限制御はBigQuery側）
end note

note across: 【言語非依存のJSONファイルで連携】

== Phase 1: データ抽出（さくらクラウド側） ==
SakuraCloud -> GCS: 1. 学習データをJSON形式で\n<font color=blue>incoming</font>バケットにアップロード
note left of SakuraCloud
  **処理内容:**
  ・PostgreSQLから増分データ抽出
  ・JSON形式に変換
  ・GCSへアップロード

  **ステータス:** <font color=red>未実装</font>
  **担当:** マグナ側
end note

== Phase 2: データ変換・ロード（Cloud Functions） ==
GCS --> CloudFunctions: 2. <font color=blue>incoming</font>バケットへの\nファイル作成イベントで自動起動

CloudFunctions -> GCS: 3. JSONファイルを取得

activate CloudFunctions
note over CloudFunctions
  **4. データ変換処理（Python）**
  ・JSONパース
  ・縦持ちイベント形式へ変換
  ・データ型変換
  ・バリデーション
end note

group エラーハンドリング処理
  alt JSONパースエラー / データ不正の場合
    CloudFunctions -> CloudFunctions: エラーログ出力・管理者通知
    CloudFunctions -> GCS: パース失敗したJSON or\nバリデーションエラーのJSONを\n<font color=blue>error</font>バケットへ移動
    note right
      **エラー時の動作:**
      ・パース不可能なJSONファイルを隔離
      ・バリデーション失敗データを隔離
      ・ChatWork/メール通知
      ・処理を継続（他ファイルに影響なし）
    end note
  else データ変換成功の場合
    CloudFunctions -> BigQuery: 5. BigQuery Load API経由で\n**raw_learning_events**テーブルへ\nバッチ書き込み

    CloudFunctions -> GCS: 6. 処理済みファイルを\n<font color=blue>archive</font>バケットへ移動
    note right
      **アーカイブ後:**
      ・90日後に自動削除（ライフサイクルポリシー）
      ・監査証跡として保管
    end note
  end
end
deactivate CloudFunctions

note right of CloudFunctions
  **ステータス:** <font color=red>未実装</font>
end note

== Phase 3: データ集計（BigQuery内部処理） ==

group BigQuery基本テーブル
    note over BigQuery #LightGreen
        **基本テーブル作成完了:**
        ✅ user_directory（生徒名簿）
        ✅ raw_learning_events（学習イベントログ）
        ✅ teacher_access_rules（先生の権限管理）
        **未作成テーブル:**
        　 aggregate_daily_student_summary（集計テーブル）
    end note
end

Scheduler -> Scheduler: 7. 毎月1日 午前2時（JST）\nスケジュール起動
note right of Scheduler
    **トリガー条件:**
    ・毎月1日 定時実行
    ・さくらのクラウドからのデータ投入完了後

    **ステータス:** <font color=red>未実装</font>
end note

Scheduler -> BigQuery: 8. **refresh_monthly_summary()**\nプロシージャを呼び出し

activate BigQuery
BigQuery -> BigQuery: 9. プロシージャ実行:\nraw_learning_events + user_directory\n↓ JOIN & 集計\naggregate_daily_student_summary 更新
note left of BigQuery
  **集計処理の内容:**
  ・日次・生徒ごとに集計
  ・進級・転校履歴を考慮
  ・タイムゾーン変換（JST）
  ・前月の2ヶ月分を処理

end note
BigQuery --> Scheduler: 10. 処理完了通知
deactivate BigQuery

== Phase 4: 可視化（Looker Studio） ==

Looker -> BigQuery: 11. ダッシュボード表示リクエスト\n（先生がログイン）

activate BigQuery
BigQuery -> BigQuery: 12. ビュー & RLS処理:\naggregate_daily_student_summary\n↓ 用途別で集計\nv_class_daily_summary / v_student_detail_base（ビュー）\n↓ 権限チェック（RLS）\nv_dashboard_student_detail_rls / v_dashboard_class_summary_rls（RLS適用ビュー）
note left of BigQuery
  **RLS（行レベルセキュリティ）:**
  ・先生のメールアドレスで識別
  ・teacher_access_rulesと照合
  ・担当クラスのみフィルタして表示

  **例:**
  田中先生（1年1組担任）がログイン
  → 1年1組のデータのみ表示

  **ステータス:** <font color=red>未実装</font>
end note
BigQuery --> Looker: 13. フィルタ済みデータを返す
deactivate BigQuery

note over Looker
  **表示内容:**
  ・学校ダッシュボード（学年別）
  ・クラスダッシュボード（生徒別）
  ・前月の2ヶ月分のデータ
end note

@enduml